## CSS 世界的层叠规则

### z-index 只是 CSS 层叠规则中的一叶小舟
> 在 CSS 世界中，z-index 属性只有和定位元素（position 不为 static 的元素）在一起的时候才有作用，可以是正数也可以是负数。理论上说，数值越大层级越高，但实际上其规则要复杂很多，这个后面会深入介绍
> 但随着 CSS3 新世界的到来，z-index 已经并非只对定位元素有效，flex 盒子的子元素也可以设置 z-index 属性

### 理解 CSS 世界的层叠上下文和层叠水平
#### [什么是层叠上下文](https://ws1.sinaimg.cn/large/0060ZzrAgy1g8ac1bzl1xj30of0a0wi7.jpg)

#### 什么是层叠水平
> 显而易见，所有的元素都有层叠水平，包括层叠上下文元素，也包括普通元素。然而，对普通元素的层叠水平探讨只局限在当前层叠上下文元素中。为什么呢？因为不如此就没有意义。层叠上下文本身就是一个强力的“层叠结界”，而普通元素的层叠水平是无法突破这个结界和结界外的元素去较量层叠水平的。
> 需要注意的是，诸位千万不要把层叠水平和 CSS 的 z-index 属性混为一谈。尽管某些情况下 z-index 确实可以影响层叠水平，但是只限于定位元素以及 flex 盒子的孩子元素；而层叠水平所有的元素都存在。

#### 理解元素的层叠顺序
> 在 CSS 2.1 的年代，在 CSS3 新世界还没有到来的时候（注意这里的前提），层叠顺序规则[如图](https://ws1.sinaimg.cn/large/0060ZzrAgy1g8e9ksbeqpj30ex09k3zu.jpg)
> + （1）位于最下面的 background/border 特指层叠上下文元素的边框和背景色。每一个层叠顺序规则仅适用于当前层叠上下文元素的小世界。
> + （2）inline 水平盒子指的是包括 inline/inline-block/inline-table 元素的“层叠顺序”，它们都是同等级别的。
> + （3）单纯从层叠水平上看，实际上 z-index:0 和 z-index:auto 是可以看成是一样的。注意这里的措辞—“单纯从层叠水平上看”，实际上，两者在层叠上下文领域有着根本性的差异。
> background/border 为装饰属性，浮动和块状元素一般用作布局，而内联元素都是内容。网页中最重要的是什么？当然是内容了！尤其是 CSS 世界是为更好的图文展示而设计的，因此，一定要让内容的层叠顺序相当高，这样当发生层叠时，重要的文字、图片内容才可以优先显示在屏幕上。

### 务必牢记的层叠准则
> 下面这两条是层叠领域的黄金准则。当元素发生层叠的时候，其覆盖关系遵循下面两条准则：
> + （1）谁大谁上：当具有明显的层叠水平标识的时候，如生效的 z-index 属性值，在同一个层叠上下文领域，层叠水平值大的那一个覆盖小的那一个。
> + （2）后来居上：当元素的层叠水平一致、层叠顺序相同的时候，在 DOM 流中处于后面的元素会覆盖前面的元素。

### 深入了解层叠上下文
#### 层叠上下文的特性
> 层叠上下文元素有如下特性。
> + 层叠上下文的层叠水平要比普通元素高
> + 层叠上下文可以阻断元素的混合模式（[参见](http://www.zhangxinxu.com/wordpress/?p=5155) 的这篇文章的第二部分说明）
> + 层叠上下文可以嵌套，内部层叠上下文及其所有子元素均受制于外部的“层叠上下文”。
> + 每个层叠上下文和兄弟元素独立，也就是说，当进行层叠变化或渲染的时候，只需要考虑后代元素。
> + 每个层叠上下文是自成体系的，当元素发生层叠的时候，整个元素被认为是在父层叠上下文的层叠顺序中。

#### 层叠上下文的创建
> 和块状格式化上下文一样，层叠上下文也基本上是由一些特定的 CSS 属性创建的。我将其总结为 3 个流派。
> + （1）天生派：页面根元素天生具有层叠上下文，称为根层叠上下文。
> + （2）正统派：z-index 值为数值的定位元素的传统“层叠上下文”。
> + （3）扩招派：其他 CSS3 属性。

> 3．CSS3 与新时代的层叠上下文
> + （1）元素为 flex 布局元素（父元素 display:flex|inline-flex），同时 z-index值不是 auto。
> + （2）元素的 opacity 值不是 1。
> + （3）元素的 transform 值不是 none。
> + （4）元素 mix-blend-mode 值不是 normal。
> + （5）元素的 filter 值不是 none。
> + （6）元素的 isolation 值是 isolate。
> + （7）元素的 will-change 属性值为上面 2～6 的任意一个（如 will-change:opacity、will-chang:transform 等）。
> + （8）元素的-webkit-overflow-scrolling 设为 touch。

#### 层叠上下文与层叠顺序
> 本章多次提到，一旦普通元素具有了层叠上下文，其层叠顺序就会变高。那它的层叠顺序究竟在哪个位置、哪个级别呢？
> + （1）如果层叠上下文元素不依赖 z-index 数值，则其层叠顺序是 z-index:auto，可看成 z:index:0 级别；
> + （2）如果层叠上下文元素依赖 z-index 数值，则其层叠顺序由 z-index 值决定。我们上面提供的层叠顺序图实际上还缺少其他重要信息。我又花工夫重新绘制了一个更完整的 7 阶层叠顺序图，[如图](https://ws1.sinaimg.cn/large/0060ZzrAgy1g8e9tffd2tj30ir0ajtae.jpg)

### z-index 负值深入理解
> 那 z-index 负值在实际项目中有什么用呢？具体作用如下。
> + （1）可访问性隐藏。z-index 负值可以隐藏元素，只需要层叠上下文内的某一个父元素加个背景色就可以。它与 clip 隐藏相比的一个优势是，元素无须绝对定位，设置position:relative 也可以隐藏，另一个优势是它对原来的布局以及元素的行为没有任何影响，而 clip 隐藏会导致控件 focus 的焦点发生细微的变化，在特定条件下是有体验问题的。它的不足之处就是不具有普遍适用性，需要其他元素配合进行隐藏。
> + （2）IE8 下的多背景模拟。CSS3 中有一个多背景特性，就是一个 background 可以写多个背景图。虽然 IE8 浏览器不支持多背景特性，但是 IE8 浏览器支持伪元素，于是，IE8 理论上也能实现多背景，这个背景最多 3 个，好在绝大多数场景 3 个背景图足矣。最麻烦的其实是这个伪元素生成的背景一定是使用 absolute 绝对定位，以免影响内容的布局。
> + （3）定位在元素的后面。[http://demo.cssworld.cn/7/6-1.php](http://demo.cssworld.cn/7/6-1.php),[如图](https://ws1.sinaimg.cn/large/0060ZzrAgy1g8ea06x8tuj30ix0bgq5c.jpg)

### z-index“不犯二”准则
> 此准则内容如下：对于非浮层元素，避免设置 z-index 值，z-index 值没有任何道理需要超过 2。由于 z-index 不能超过 2，因此，我称其为“不犯二”准则。
> + （1）定位元素一旦设置了 z-index 值，就从普通定位元素变成了层叠上下文元素，相互间的层叠顺序就发生了根本的变化，很容易出现设置了巨大的 z-index 值也无法覆盖其他元素的问题。
> + （2）避免 z-index“一山比一山高”的样式混乱问题。此问题多发生在多人协作以及后期维护的时候。例如，A 小图标定位，习惯性写了个 z-index:9；B 一看，自己原来的实现被覆盖了，立马写了个 z-index:99；结果比弹框组件层级还高，那还得了，立马弹框组件来一个z-index:999999；谁知后来，弹框中又要有出错提示效果……显然，最后项目的 z-index层级管理就是一团糟。
> 很重要的一点，我这里的“不犯二”准则，并不包括那些在页面上飘来飘去的元素定位，弹框、出错提示、一些下拉效果等都不受这一准则限制。
> 对于这类 JavaScript 驱动的浮层组件，我会借助“层级计数器”来管理，原因如下：
> + （1）总会遇到意想不到的高层级元素；
> + （2）组件的覆盖规则具有动态性。
> 所谓“层级计数器”，实际上就是一段 JavaScript 脚本，会遍历所有\<body>处于显示状态的子元素，并得到最大 z-index 值，和默认的 z-index 做比较。如果超出，则显示的组件的z-index 自动加 1，这样就不会出现有组件被其他组件覆盖的问题；如果不超出，就使用默认的 z-index 值，我习惯设成 9，因为遵循“不犯二”准则的情况下，9 已经是个足够安全的值了，浮层组件根本无须担心会被页面上某个元素层级覆盖。